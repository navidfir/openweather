# Minimal necessary configuration to run Nginx
worker_processes auto;

events {
    worker_connections 1024;
}

# The stream block is for TCP/UDP load balancing
stream {
    # UPSTREAM FOR READS (Replica Load Balancing)
    upstream pg_reads {
        # least_conn is a good load balancing method for databases
        least_conn;
        
        # Use the service names from docker-compose for internal routing
        # The port is the internal container port (5432)
        server postgres_replica:5432;
        server postgres_replica_2:5432; # Added second replica
    }

    # UPSTREAM FOR WRITES (Primary/Master)
    upstream pg_writes {
        # Only one server, all writes go here
        server postgres_primary:5432;
    }

    # SERVER BLOCK 1: Listens on 127.0.0.1:5432 for READS
    server {
        listen 127.0.0.1:5432;
        proxy_pass pg_reads;
        proxy_timeout 10s;
        proxy_connect_timeout 5s;
    }

    # SERVER BLOCK 2: Listens on 127.0.0.1:5433 for WRITES
    server {
        listen 127.0.0.1:5433;
        proxy_pass pg_writes;
        proxy_timeout 10s;
        proxy_connect_timeout 5s;
    }
}